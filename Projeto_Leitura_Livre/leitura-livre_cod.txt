-- 1. Criação do Database
CREATE DATABASE IF NOT EXISTS Leitura_Livre;
USE Leitura_Livre;


-- 2. CRIAÇÃO DAS TABELAS (DDL)

CREATE TABLE genero (
    id_genero INT AUTO_INCREMENT PRIMARY KEY,
    descricao VARCHAR(50) NOT NULL
);

CREATE TABLE editora (
    id_editora INT AUTO_INCREMENT PRIMARY KEY,
    nome_fantasia VARCHAR(100) NOT NULL,
    email_contato VARCHAR(100)
);

CREATE TABLE autor (
    id_autor INT AUTO_INCREMENT PRIMARY KEY,
    nome_completo VARCHAR(100) NOT NULL,
    nacionalidade VARCHAR(50)
);

CREATE TABLE usuario (
    id_usuario INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    cpf CHAR(11) UNIQUE NOT NULL,
    logradouro VARCHAR(100),
    cidade VARCHAR(50),
    uf CHAR(2)
);

CREATE TABLE obra (
    id_obra INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(150) NOT NULL,
    isbn VARCHAR(20) UNIQUE,
    ano_publicacao INT,
    id_editora INT NOT NULL,
    id_genero INT NOT NULL,
    FOREIGN KEY (id_editora) REFERENCES editora(id_editora),
    FOREIGN KEY (id_genero) REFERENCES genero(id_genero)
);

CREATE TABLE autoria (
    id_obra INT,
    id_autor INT,
    tipo_participacao VARCHAR(50) DEFAULT 'Autor Principal',
    PRIMARY KEY (id_obra, id_autor),
    FOREIGN KEY (id_obra) REFERENCES obra(id_obra),
    FOREIGN KEY (id_autor) REFERENCES autor(id_autor)
);

CREATE TABLE exemplar (
    id_exemplar INT AUTO_INCREMENT PRIMARY KEY,
    id_obra INT NOT NULL,
    codigo_tombo VARCHAR(20) UNIQUE NOT NULL,
    estado_conservacao VARCHAR(50),
    status ENUM('Disponível', 'Emprestado', 'Manutenção', 'Extraviado') DEFAULT 'Disponível',
    FOREIGN KEY (id_obra) REFERENCES obra(id_obra)
);

CREATE TABLE telefone_usuario (
    id_telefone INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    numero VARCHAR(20) NOT NULL,
    tipo VARCHAR(20) DEFAULT 'Celular',
    FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario)
        ON DELETE CASCADE 
);

CREATE TABLE emprestimo (
    id_emprestimo INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    data_retirada DATE NOT NULL,
    data_prevista_devolucao DATE NOT NULL,
    data_real_devolucao DATE,
    FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario)
);

CREATE TABLE item_emprestimo (
    id_item INT AUTO_INCREMENT PRIMARY KEY,
    id_emprestimo INT NOT NULL,
    id_exemplar INT NOT NULL,
    FOREIGN KEY (id_emprestimo) REFERENCES emprestimo(id_emprestimo),
    FOREIGN KEY (id_exemplar) REFERENCES exemplar(id_exemplar)
);

CREATE TABLE multa (
    id_multa INT AUTO_INCREMENT PRIMARY KEY,
    id_emprestimo INT NOT NULL,
    valor DECIMAL(10, 2) NOT NULL,
    data_geracao DATE NOT NULL,
    status_pagamento ENUM('Pendente', 'Pago', 'Isento') DEFAULT 'Pendente',
    FOREIGN KEY (id_emprestimo) REFERENCES emprestimo(id_emprestimo)
);

-- 3. INSERÇÃO DE DADOS (DML)

INSERT INTO genero (descricao) VALUES ('Ficção'), ('Técnico'), ('Romance');
INSERT INTO editora (nome_fantasia, email_contato) VALUES ('Editora Alpha', 'contato@alpha.com'), ('Editora Beta', 'sac@beta.com');
INSERT INTO autor (nome_completo, nacionalidade) VALUES ('Machado de Assis', 'Brasileira'), ('George Orwell', 'Britânica');

INSERT INTO obra (titulo, isbn, ano_publicacao, id_editora, id_genero) VALUES 
('Dom Casmurro', '9788500001', 1899, 1, 3),
('1984', '9788500002', 1949, 2, 1);

INSERT INTO autoria (id_obra, id_autor) VALUES (1, 1), (2, 2);

INSERT INTO exemplar (id_obra, codigo_tombo, status) VALUES 
(1, 'LIV-001', 'Disponível'), 
(1, 'LIV-002', 'Emprestado'), 
(2, 'LIV-003', 'Disponível'); 

INSERT INTO usuario (nome, cpf, cidade, uf) VALUES ('João Estudante', '11122233344', 'São Paulo', 'SP');
INSERT INTO telefone_usuario (id_usuario, numero) VALUES (1, '(11) 99999-8888');

INSERT INTO emprestimo (id_usuario, data_retirada, data_prevista_devolucao) VALUES (1, CURDATE(), DATE_ADD(CURDATE(), INTERVAL 15 DAY));
INSERT INTO item_emprestimo (id_emprestimo, id_exemplar) VALUES (1, 2);